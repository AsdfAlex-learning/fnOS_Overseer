<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>动态报表</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<link rel="stylesheet" href="./style.css">
<script src="./theme.js"></script>
</head>
<body>
<header class="app-nav">
  <div class="container">
    <ul>
      <li><a href="./index.html">首页</a></li>
      <li><a href="./config.html">配置</a></li>
    </ul>
    <button class="btn ghost theme-toggle" id="theme-toggle" onclick="window.__themeToggle()" aria-label="切换主题"></button>
  </div>
</header>
<main class="container main-content">
<h1 class="main-page-title">动态报表</h1>
<div class="grid">
  <div class="card">
    <h2>CPU 使用</h2>
    <div id="cpuChart" style="height:280px;"></div>
  </div>
  <div class="card">
    <h2>功耗拆分</h2>
    <div id="powerChart" style="height:280px;"></div>
  </div>
</div>
<div class="card">
  <h2>存储概览</h2>
  <table class="data-table" id="storageTable">
    <thead><tr><th>设备</th><th>挂载点</th><th>类型</th><th>总容量(GB)</th><th>已用(GB)</th><th>使用率(%)</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<div class="actions">
  <button class="btn" id="genReport">生成日报</button>
  <span id="genHint"></span>
  <a class="btn" href="./index.html">返回首页</a>
</div>
</main>
<script>
function renderCPU(usage) {
  const chart = echarts.init(document.getElementById('cpuChart'));
  chart.setOption({
    series: [{ type: 'gauge', progress: {show: true}, detail: {valueAnimation: true, formatter: '{value}%'}, data: [{value: usage}]}]
  });
}
function renderPower(breakdown) {
  const chart = echarts.init(document.getElementById('powerChart'));
  const data = Object.keys(breakdown).map(k => ({name: k, value: breakdown[k]}));
  chart.setOption({ tooltip: {}, series: [{ type: 'pie', radius: '60%', data }] });
}
function renderStorage(items) {
  const tbody = document.querySelector('#storageTable tbody');
  tbody.innerHTML = '';
  items.forEach(x => {
    const tr = document.createElement('tr');
    const u = x.usage || {};
    tr.innerHTML = '<td>'+x.device+'</td><td>'+x.mountpoint+'</td><td>'+x.fstype+'</td><td>'+u.total_gb+'</td><td>'+u.used_gb+'</td><td>'+u.percent+'</td>';
    tbody.appendChild(tr);
  });
}
function load() {
  axios.get('/api/v1/monitor/cpu').then(res => {
    const d = res.data && res.data.data;
    renderCPU(d.usage_percent || 0);
  }).catch(() => {});
  axios.get('/api/v1/monitor/power').then(res => {
    const d = res.data && res.data.data;
    renderPower(d.breakdown || {});
  }).catch(() => {});
  axios.get('/api/v1/monitor/storage').then(res => {
    const d = res.data && res.data.data;
    renderStorage(d || []);
  }).catch(() => {});
}
document.getElementById('genReport').onclick = () => {
  axios.post('/api/v1/report/generate').then(res => {
    const d = res.data && res.data.data;
    document.getElementById('genHint').textContent = d && d.path ? ('已生成: ' + d.path) : '已生成';
  }).catch(() => { document.getElementById('genHint').textContent = '生成失败'; });
};
load();
</script>
</body>
</html>
