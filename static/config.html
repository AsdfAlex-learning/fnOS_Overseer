<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>配置</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="./style.css">
<script src="./theme.js"></script>
</head>
<body>
<header class="app-nav">
  <div class="container">
    <ul>
      <li><a href="./index.html">首页</a></li>
      <li><a href="./dynamic_report.html">动态报表</a></li>
    </ul>
    <button class="btn ghost theme-toggle" id="theme-toggle" onclick="window.__themeToggle()" aria-label="切换主题"></button>
  </div>
</header>
<main class="container main-content">
<h1 class="main-page-title">配置</h1>
<div class="grid">
  <div class="card">
    <h2>邮件通知</h2>
    <div class="form-row">
      <label>SMTP_HOST</label>
      <span class="form-desc">邮件服务器地址，如 smtp.qq.com 或 smtp.gmail.com</span>
      <input id="SMTP_HOST">
    </div>
    <div class="form-row">
      <label>SMTP_PORT</label>
      <span class="form-desc">服务器端口，通常 SSL 为 465，非 SSL 为 25 或 587</span>
      <input id="SMTP_PORT" type="number">
    </div>
    <div class="form-row">
      <label>SMTP_USER</label>
      <span class="form-desc">您的邮箱账号，如 example@qq.com</span>
      <input id="SMTP_USER">
    </div>
    <div class="form-row">
      <label>SMTP_PASS</label>
      <span class="form-desc">邮箱授权码（非登录密码），需在邮箱设置中开启 SMTP 获取</span>
      <input id="SMTP_PASS" type="password">
    </div>
    <div class="form-row">
      <label>SMTP_TLS</label>
      <span class="form-desc">是否启用加密，SSL/TLS 请选择 true，否则选择 false</span>
      <select id="SMTP_TLS">
        <option value="true">true (启用)</option>
        <option value="false">false (禁用)</option>
      </select>
    </div>
    <div class="form-row">
      <label>EMAIL_FROM</label>
      <span class="form-desc">发件人显示名称或邮箱地址</span>
      <input id="EMAIL_FROM">
    </div>
    <div class="form-row">
      <label>EMAIL_TO</label>
      <span class="form-desc">接收通知的邮箱，多个地址用英文逗号分隔</span>
      <input id="EMAIL_TO" placeholder="comma separated">
    </div>
  </div>
  <div class="card">
    <h2>fnOS 系统连接</h2>
    <div class="form-row">
      <label>FNOS_BASE_URL</label>
      <span class="form-desc">fnOS 的访问地址，需包含协议和端口，如 http://192.168.1.100:8000</span>
      <input id="FNOS_BASE_URL" placeholder="http://127.0.0.1:8000">
    </div>
    <div class="form-row">
      <label>FNOS_SUPER_TOKEN</label>
      <span class="form-desc">fnOS 的超级管理员 Token，用于 API 鉴权</span>
      <input id="FNOS_SUPER_TOKEN" type="password">
    </div>
    <div class="form-row">
      <label>FNOS_AUTH_CHECK_PATH</label>
      <span class="form-desc">身份验证检查接口路径，默认一般无需修改</span>
      <input id="FNOS_AUTH_CHECK_PATH" placeholder="/api/v1/admin/me">
    </div>
    <div class="form-row">
      <label>FNOS_HW_PATH</label>
      <span class="form-desc">硬件信息获取接口路径，默认一般无需修改</span>
      <input id="FNOS_HW_PATH" placeholder="/api/v1/hardware">
    </div>
  </div>
  <div class="card">
    <h2>性能与模式</h2>
    <div class="form-row">
      <label>采集间隔 (秒)</label>
      <span class="form-desc">硬件数据采集的频率，建议 60-900 秒</span>
      <input id="performance.collect_interval" type="number" placeholder="900">
    </div>
    <div class="form-row">
      <label>网页模式</label>
      <span class="form-desc">Static: 仅浏览已生成的报表; Dynamic: 实时调用 API</span>
      <select id="performance.web_mode">
        <option value="static">Static (静态)</option>
        <option value="dynamic">Dynamic (动态)</option>
      </select>
    </div>
    <div class="form-row">
      <label>报表保留天数</label>
      <span class="form-desc">自动清理过期报表文件</span>
      <input id="performance.report_keep_days" type="number" placeholder="30">
    </div>
    <div class="form-row">
      <label>CPU 核心限制</label>
      <span class="form-desc">限制应用使用的最大核心数</span>
      <input id="performance.cpu_core_limit" type="number" placeholder="1">
    </div>
  </div>
  <div class="card">
    <h2>定时计划</h2>
    <div class="form-row">
      <label>报表发送时间</label>
      <span class="form-desc">每天自动发送静态报表的时间 (24小时制)</span>
      <input id="schedule.report_time" type="time">
    </div>
  </div>
</div>
<div class="actions">
  <button class="btn" id="saveBtn">保存到 config.yaml</button>
  <span class="hint" id="hint"></span>
</div>
</main>
<script>
  const CACHE_KEY = 'config_cache';
  const CACHE_DURATION = 60 * 1000; // 60 seconds

  function load() {
    const populateForm = (data) => {
      const env = data.env || {};
      const yaml = data.yaml || {};
      
      const ids = [
        'SMTP_HOST','SMTP_PORT','SMTP_USER','SMTP_TLS','EMAIL_FROM','EMAIL_TO',
        'FNOS_BASE_URL','FNOS_AUTH_CHECK_PATH','FNOS_HW_PATH'
      ];
      ids.forEach(id => { 
        if (env[id] !== undefined) {
          document.getElementById(id).value = env[id]; 
        }
      });

      // Handle nested yaml config using dot notation ids
      const nestedIds = [
        'schedule.report_time',
        'performance.collect_interval',
        'performance.web_mode',
        'performance.report_keep_days',
        'performance.cpu_core_limit'
      ];
      
      nestedIds.forEach(id => {
        const parts = id.split('.');
        let val = yaml;
        for (const p of parts) {
          val = val && val[p];
        }
        if (val !== undefined && val !== null) {
          document.getElementById(id).value = val;
        }
      });
    };

    try {
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const { timestamp, data } = JSON.parse(cached);
        if (Date.now() - timestamp < CACHE_DURATION) {
          console.log('Using cached config');
          populateForm(data);
          return;
        }
      }
    } catch (e) {
      console.error('Cache parse error', e);
    }
  
    axios.get('/api/v1/config').then(res => {
      const data = (res.data && res.data.data) || {};
      
      // Save to cache
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        timestamp: Date.now(),
        data: data
      }));
      
      populateForm(data);
    }).catch(() => {});
  }

  document.getElementById('saveBtn').onclick = () => {
    const ids = [
      'SMTP_HOST','SMTP_PORT','SMTP_USER','SMTP_PASS','SMTP_TLS','EMAIL_FROM','EMAIL_TO',
      'FNOS_BASE_URL','FNOS_SUPER_TOKEN','FNOS_AUTH_CHECK_PATH','FNOS_HW_PATH',
      'schedule.report_time',
      'performance.collect_interval',
      'performance.web_mode',
      'performance.report_keep_days',
      'performance.cpu_core_limit'
    ];
    const payload = {};
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const v = el.value;
        if (v !== '') {
            // Check if it's a number input to convert type
            if (el.type === 'number') {
                payload[id] = Number(v);
            } else {
                payload[id] = v;
            }
        }
      }
    });
    axios.post('/api/v1/config', payload).then(res => {
      const data = (res.data && res.data.data) || {};
      // Update cache on save
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        timestamp: Date.now(),
        data: data
      }));
      document.getElementById('hint').textContent = '已保存';
    }).catch(() => { document.getElementById('hint').textContent = '保存失败'; });
  };
  load();
  </script>
</body>
</html>
